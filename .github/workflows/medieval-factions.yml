name: Build
on:
  pull_request:
    branches:
    - develop
permissions:
  contents: read
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
    - name: Build with Gradle
      uses: gradle/gradle-build-action@v2
      with:
        arguments: build
  
  test-standalone-build-script-linux:
    runs-on: ubuntu-latest
    steps:
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Set up Git
      run: |
        git config --global user.email "ci@github.com"
        git config --global user.name "CI Bot"
    
    - name: Download standalone build script
      run: |
        # Download the build script from the PR branch
        BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
        echo "Downloading build script from branch: $BRANCH_NAME"
        curl -O https://raw.githubusercontent.com/${{ github.repository }}/$BRANCH_NAME/build.sh
        chmod +x build.sh
    
    - name: Test standalone build script
      run: |
        # Run the standalone build script
        # Pass the PR branch name so it builds the code being tested
        BRANCH_NAME="${{ github.head_ref || github.ref_name }}"
        echo "Testing build script with branch: $BRANCH_NAME"
        ./build.sh "$BRANCH_NAME"
        
        # Verify the JAR was created
        if ls Medieval-Factions-*-all.jar 1> /dev/null 2>&1; then
          echo "✓ Standalone build script successfully created JAR"
          ls -lh Medieval-Factions-*-all.jar
        else
          echo "✗ Standalone build script failed to create JAR"
          exit 1
        fi
  
  test-standalone-build-script-windows:
    runs-on: windows-latest
    steps:
    - name: Set up JDK 21
      uses: actions/setup-java@v3
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Set up Git
      run: |
        git config --global user.email "ci@github.com"
        git config --global user.name "CI Bot"
    
    - name: Download standalone build script
      run: |
        # Download the build script from the PR branch
        $BranchName = "${{ github.head_ref || github.ref_name }}"
        Write-Host "Downloading build script from branch: $BranchName"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/${{ github.repository }}/$BranchName/build.bat" -OutFile "build.bat"
    
    - name: Test standalone build script
      run: |
        # Run the standalone build script
        # Pass the PR branch name so it builds the code being tested
        set BRANCH_NAME=${{ github.head_ref || github.ref_name }}
        echo Testing build script with branch: %BRANCH_NAME%
        call build.bat "%BRANCH_NAME%"
      shell: cmd
    
    - name: Verify JAR was created
      run: |
        $jarFiles = Get-ChildItem -Path . -Filter "Medieval-Factions-*-all.jar"
        if ($jarFiles.Count -gt 0) {
          Write-Host "✓ Standalone build script successfully created JAR"
          Get-ChildItem Medieval-Factions-*-all.jar | Format-Table Name, Length
        } else {
          Write-Host "✗ Standalone build script failed to create JAR"
          exit 1
        }
      shell: powershell